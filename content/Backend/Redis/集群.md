## 主从复制简介
- 互联网三高架构:
   - 高并发
   - 高性能
   - 高可用
 
 - 你的REDIS是否高可用
   - 单机REDIS的风险与问题
     - 问题1:机器故障
      - 现象: 硬盘故障、系统崩溃
      - 本质: 数据丢失、很可能对业务造成灾难性打击
      - 结论: 基本会放弃使用redis
    - 问题2.容量瓶劲
      - 现象: 内存不足,从16G升级到64G。。。。无限升级内存
      
    结论: 
    为了避免单点服务器故障,准备多台服务器,互相连通,将数据保存不同副本在服务器上，连接在一起,并保障数据是同步的,即使有一台服务器宕机,其他服务器也可以提供服务.
 
 多台服务器连接方案:
 提供数据方: master
 主服务器,主节点,主库
 主客户端
 接收数据方:slave
 从服务器,从节点,从库
 从客户端
 
特征: 一个master可以拥有多个slave,一个slave只对应一个master.

主从复制的简介:
高可用集群: 如果主机出问题,那么临时推选出一个从机当主机,其他从机继续当从机

### 主从复制的作用:
- 读写分离:master写,slave读,提高服务器的读写负载能力
- 负载均衡:基于主从结构,配合读写分离,由slave分担master的负载,并根据需求的变化,改变slave的数据量,通过多个从节点分担数据读取负载,大大提高其吞吐量和并发量
- 故障恢复:当master出现问题时,由slave提供服务,实现快速的数据恢复
- 数据冗余:实现数据备份


### 工作流程
主从复制过程大体分为3个阶段
 - 建立连接阶段
    - 1. 发送指令: slaveof ip port 
    - 2.master接收指令并响应
    - 3.保存master的ip和port: masterhost 和masterport
    - 4.保存的信息创建连接master的socket
    - 5.周期性的向master发送数据
    - 6.master对其响应
    - 7.发送指令
    - 8.验证授权
    - 9.replconf listening-port <port-number>
    - 10.保存slave端口号
 - 数据同步阶段
    - 1. 请求数据同步,发送指令psync2
    - 2.master执行bgsave
    - 3.第一个slave连接时,创建命令缓冲区
    - 4.生成RDB文件,通过socket发送给slave
    - 5.接收RDB,清空数据,执行RDB恢复文件过程
    - 6.发送命令告知RDB已经恢复完成
    - 7.发送复制缓冲区的信息
    - 8.slave接收信息,执行bgrewriteaof,恢复数据
   
 - 命令传播阶段
    - 1.不停的做同步过程
   
   - 复制缓冲区
    概念:复制挤压缓冲区,是一个先进先出的队列FIFO,用于存储服务器执行过的命令,每次传播命令,master都将会传播命令记录下来,并存储在缓冲区.
    内部远离: 组成:偏移量、字节值  工作原理:通过offset区分不同的slave当前的数据传播的差异
    
    
    
    
  心跳机制:
  当slave多数掉线,或延迟较高时,master为保障数据稳定性,将拒绝所有信息同步操作
  
  ```
  min-slaves-to-write 2
  
  min-slaves-max-lag 8
  
 ```
 
 